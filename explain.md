---
title: PowerPointのタイトル名
subtitle: サブタイトル名
author: KatusothiOtogawa
date: 20211218
---

## 速度どうにかならん?

ああああ

## 要望

pythonで書いた決済周りのバッチ処理が終わらない。 \
トラブルや急な仕様変更があった場合、デバッグに時間がかかりすぎるため怖すぎる。 \
どうにかして欲しい。

## 状況

1. 外部システムから月の最初の週にデータが帰ってくる。

2. そのデータは即時に計算して遅くとも次の日にはお客さんに見えるようにしたい。

3. バッチサーバーはEC2、DBはマネージド。

4. エンジニアの人手が少なすぎる。みんなが運用、開発、ヘルプデスクをやっている状況。

## 何を採用するか?1

候補として次を考えました。とりあえずダメなところ列挙。

- 他のスクリプト言語 -> そもそもpythonはスクリプト言語の中では早い方なので論外。速度が上がってもおそらくそんなに変わらない。
- Java -> エンジニアの単価が高い。開発速度遅い。ネットの情報あてにならない。社内にJavaの資産があって流用できるならまだいいが...また経験年数があてにならない
- C# -> .netの変化が激しい上、.net 6.0のltsが出るかどうかという時期。linuxの実績は少なそうだし、採用している人が周りにいない

## 何を採用するか?2

- Rust -> まだ若く、定番のframeworkが無い。また0系列のライブラリが多すぎる...情報が少ないためスキル差が出やすく、トラブル起きたらどうしよう...

- Golang -> エンジニアの単価が高い。書き方が強制されることが多いので、エンジニアの好き嫌いが激しい。レポジトリ、パッケージの考え方に癖があり、ハマる人はいそう。

## 一番コントロール効きやすそうなのは?

この中で現時点で一番環境に影響されず、自分が書いて他の人も書いていく...という横展開が楽そうなのはGolangと考えて着手。

- 書き方が強制される -> pythonと比べて書くのに時間がかかるが、最初に書いた人がエラー処理や関数名などを丁寧に書けば、コピペして処理を変えれば同じ要領でかけるので運用時も開発時もデバック楽そう。今の開発と並行して書く上ではメリットになる。遅い処理をgolangに書きこのメリットを生かすために関数は一つのことを上手にやるように書いた。

- エンジニアの単価が高いだけは解消されないが、プロジェクトに参加しているエンジニアは平均レベルが高かったので、
ちゃんとドキュメント、コメント、どういう要領で書けば、はまりどころなどを説明したら運用できそうと判断。

- PMが今後事業としてSESも考えていると言っていたので、単価が高いのが会社にとってメリットにもなるのでは？という観点でも説明。

## 採用したframework

GitHub Action -> golangのビルドに使用。リモートにpushしたら自動的にビルド。revisionがわかるようにして。

chromedp -> スクレイピング用のライブラリ。外部のシステムでAPI提供していないものからデータとってくるのに使用。

gin -> apiサーバー。書き方だけレポジトリ本番ではまだ運用していない。

## 以下のレイヤー、処理に分けてバッチを考える

データベース層 -> データベースのアクセスと値の加工、演算処理だけする。

外部システムのapi(データ取得,変更) -> それぞれシステムの名前で分ける。

社内システムのためのapi(事務、経理、経営者向けにデータをpushする。主に人間に見せるのが仕事。) -> slackのapi(golangではなかったのでhtml post, get)とか。

上のやつを適当に組み合わせる層 -> バッチが実際に実行するのはこの層。

呼び出す層 -> バッチからのエントリーポイント

## apiサーバーのことも考える

今は言うほど問題になっていないが、データが増えるにつれ既存のapiサーバーが遅くなるのを状況として感じている。
データベースの処理だけレポジトリ分けて、apiサーバーも同じpackageを参照するようにしたら、
apiサーバーとバッチサーバーの処理が一致するので管理が楽になりそう。

## 着手に当たって

## 結果として

処理時間を1/5に短縮。 \
今までスペックがアホみたいに高い自作PCでやってた処理が \
すぐ終わるように。

```sql
select *
from abc
```

## しかし...やはり

1. SQLの最適化,IOによる影響が一番大きかった。

2. 演算処理、集計処理、値の加工はDB側で行う -> マネージドならスペック的に足りなくなったらDBに課金でOK。遅い場合の問題の切り分け楽。

3. python -> Golangにしてメモリ的にはかなり余裕を持てるようになったので、そこは大きなメリット。
